<!DOCTYPE html>
<html>

<head>
    <title>Get Image</title>
    <style>
        html,
        body,
        main {
            margin: 0;
            padding: 0;
        }

        body {
            overflow: hidden;
        }

        img {
            position: absolute;
            top: 180px;
        }

        #allimages {
            display: none
        }

        #watchface {
            position: absolute;
            top: 0;
            height: 176px;
            width: 176px;
            float: left;
        }

        #watchface-cover {
            position: absolute;
            width: 176px;
            height: 176px;
            top: 0;
        }

        hr {
            border: none;
        }

        #inputblock {
            margin-left: 200px;
        }

    </style>
    <link href="uikit/uikit.min.css" rel="stylesheet">
    <script src="uikit/uikit.min.js"></script>
</head>

<body>
    <main>
        <div id="watchface"></div>
        <div id="watchface-cover"><svg id="svg-cont" width="176" height="176"></svg></div>
        <div id="inputblock" class="uk-margin">
            <!--            <input id="inputimages" type="file" multiple accept=".png" onclick="clearimg()">-->
            <div class="js-upload" uk-form-custom>
                <span>Images: </span>
                <input id="inputimages" type="file" multiple accept=".png" onclick="clearimg()">
                <button class="uk-button uk-button-default uk-button-small" type="button" tabindex="-1">Select</button>
            </div>
            <br>
            <!--            <input id="inputjs" type="file" accept=".json" onclick="clearjs()">-->
            <div class="js-upload uk-margin" uk-form-custom>
                <span>JSON: </span>
                <input id="inputjs" type="file" accept=".json" onclick="clearjs()">
                <button class="uk-button uk-button-default uk-button-small" type="button" tabindex="-1">Select</button>
            </div>
            <br>
            <button id="make" class="uk-button uk-button-primary" onclick="makeWf()" disabled>Load</button>
            <button id="makepng" class="uk-button uk-button-default" onclick="makepng()">Make PNG</button>
        </div>
        <div id="allimages">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeAQMAAAAB/jzhAAAAAXNSR0IArs4c6QAAAAZQTFRFAAAA////pdmf3QAAAKFJREFUeAEBlgBp/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAfgAAAAH/gAAAA8PAAAAHAOAAAAYAYAAADgBwAAAMADAAADwAPwAA/Dw/wAHgfjHgAYDnQGADgMMAcAMAwwAwAwADADADAAcAMAOADgBwAYAcAGAB4BgB4ADgGAPAACAAAwAAABgAAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAABLmFx2EXu51AAAAAElFTkSuQmCC" id="weather">
        </div>
    </main>
    <script>
        var jsset = 0,
            imagesset = 0;

        function disableBtn(i) {
            if (i)
                document.getElementById("make").removeAttribute("disabled");
            else
                document.getElementById("make").setAttribute("disabled", "");
        }

        var coords;

        function makeBlock(el, value) {
            var block = Array(),
                width = 0,
                t,
                val = Array();
            while (value) {
                val.push(value % 10);
                value = (value - value % 10) / 10;
            }
            while (val.length) {
                t = document.getElementById(el.ImageIndex + val[val.length - 1]).cloneNode(false);
                block.push(t);
                width += t.width + el.Spacing;
                val.pop();
            }
            width = width - el.Spacing;
            return {
                block,
                width
            }
        }

        function renderBlock(block, width, el) {
            var t, offset = 0;
            if (el.Alignment == 18) {
                block.reverse();
                while (block.length) {
                    t = block.pop();
                    t.style.left = el.TopLeftX + offset + "px";
                    t.style.top = el.TopLeftY + "px";
                    insert(t);
                    offset += t.width + el.Spacing;
                }
            } else if (el.Alignment == 20) {
                while (block.length) {
                    t = block.pop();
                    t.style.left = el.BottomRightX - t.width + 1 - offset + "px";
                    t.style.top = el.TopLeftY + "px";
                    insert(t);
                    offset += t.width + el.Spacing;
                }
            } else if (el.Alignment == 34) {
                while (block.length) {
                    t = block.pop();
                    t.style.left = el.BottomRightX - t.width + 1 - offset + "px";
                    t.style.top = el.BottomRightY - t.height + 1 + "px";
                    insert(t);
                    offset += t.width + el.Spacing;
                }
            } else if (el.Alignment == 24) {
                block.reverse();
                offset = div(((el.BottomRightX - el.TopLeftX + 1) - width), 2);
                console.log(offset);
                while (block.length) {
                    t = block.pop();
                    t.style.left = el.TopLeftX + offset + "px";
                    t.style.top = el.TopLeftY + "px";
                    insert(t);
                    offset += t.width + el.Spacing;
                }
            }
        }

        function clearjs() {
            //document.getElementById('inputjs').value = '';
            document.getElementById('inputjs').innerHTML = document.getElementById('inputjs').innerHTML;
            coords = 0;
        }

        function clearimg() {
            //document.getElementById('inputimages').value = '';
            document.getElementById('inputimages').innerHTML = document.getElementById('inputimages').innerHTML;
            document.getElementById('allimages').innerHTML = "<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeAQMAAAAB/jzhAAAAAXNSR0IArs4c6QAAAAZQTFRFAAAA////pdmf3QAAAKFJREFUeAEBlgBp/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAfgAAAAH/gAAAA8PAAAAHAOAAAAYAYAAADgBwAAAMADAAADwAPwAA/Dw/wAHgfjHgAYDnQGADgMMAcAMAwwAwAwADADADAAcAMAOADgBwAYAcAGAB4BgB4ADgGAPAACAAAwAAABgAAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAABLmFx2EXu51AAAAAElFTkSuQmCC\" id=\"weather\">";
        }

        function div(a, b) {
            var c = (a - a % b) / b;
            return c;
        }

        function renderImage(file) {
            var reader = new FileReader();
            reader.onload = function(event) {
                the_url = event.target.result;
                document.getElementById('allimages').innerHTML += "<img src=\"" + the_url + "\" id=\"" + file.name.replace('.png', '') + "\" >";
            }
            //console.log(file);
            reader.readAsDataURL(file);
            delete reader;
        }

        document.getElementById('inputimages').onchange = function() {
            if (this.files.length) {
                var i = 0;
                console.log(this.files);
                while (i < this.files.length) {
                    renderImage(this.files[i]);
                    i++;
                }
                UIkit.notification("Images loaded", {
                    status: 'success',
                    timeout: 2000
                });
                imagesset = 1;
                if (document.getElementById('inputimages').nextElementSibling.classList.contains("uk-button-danger"))
                    document.getElementById('inputimages').nextElementSibling.classList.remove("uk-button-danger");
                document.getElementById('inputimages').nextElementSibling.classList.add("uk-label-success");
            } else {
                UIkit.notification("Images not selected", {
                    status: 'warning',
                    timeout: 2000
                });
                imagesset = 0;
                if (document.getElementById('inputimages').nextElementSibling.classList.contains("uk-label-success")) document.getElementById('inputimages').nextElementSibling.classList.remove("uk-label-success");
                document.getElementById('inputimages').nextElementSibling.classList.add("uk-button-danger");
            }
            if (imagesset && jsset)
                disableBtn(1);
            else
                disableBtn(0);
        }

        document.getElementById('inputjs').onchange = function() {
            if (this.files.length) {
                console.log(this.files);
                var reader = new FileReader();
                reader.onload = function(e) {
                    coords = JSON.parse(e.target.result);
                };
                reader.readAsText(this.files[0]);
                delete reader;
                UIkit.notification("JSON loaded", {
                    status: 'success',
                    timeout: 2000
                });
                jsset = 1;
                if (document.getElementById('inputjs').nextElementSibling.classList.contains("uk-button-danger"))
                    document.getElementById('inputjs').nextElementSibling.classList.remove("uk-button-danger");
                document.getElementById('inputjs').nextElementSibling.classList.add("uk-label-success");
            } else {
                UIkit.notification("JSON not selected", {
                    status: 'warning',
                    timeout: 2000
                });
                jsset = 0;
                if (document.getElementById('inputjs').nextElementSibling.classList.contains("uk-label-success")) document.getElementById('inputjs').nextElementSibling.classList.remove("uk-label-success");
                document.getElementById('inputjs').nextElementSibling.classList.add("uk-button-danger");
            }
            if (imagesset && jsset)
                disableBtn(1);
            else
                disableBtn(0);
        }

        function setPos(t, el) {
            t.style.left = el.X + "px";
            t.style.top = el.Y + "px";
        }

        function setPosN(el, value) {
            if (value == null) value = 0;
            t = document.getElementById(el.ImageIndex + value).cloneNode(false);
            t.style.left = el.X + "px";
            t.style.top = el.Y + "px";
            insert(t);
        }

        function insert(t) {
            t.removeAttribute('id');
            document.getElementById("watchface").appendChild(t);
        }

        function setTextPos(el, value) {
            var t = makeBlock(el, value);
            renderBlock(t.block, t.width, el);
        }

        function drowAnalog(el, value) {
            var col = el.Color.replace("0x", "#"),
                d = "M 0 0 ",
                iters = el.Shape.length,
                fill = el.OnlyBorder ? "none" : col;
            for (var i = 0; i < iters; i++) {
                d += "L " + el.Shape[i].X + " " + el.Shape[i].Y + " ";
            }
            d += "L " + el.Shape[0].X + " " + el.Shape[0].Y + " ";
            document.getElementById('svg-cont').innerHTML += "<path d=\"" + d + "\" transform=\"rotate(" + value + " " + el.Center.X + " " + el.Center.Y + ") rotate(-90 " + el.Center.X + " 0)\" fill=\"" + fill + "\" stroke=\"" + col + "\"></path>";
            if ('CenterImage' in el) {
                setPosN(el.CenterImage);
            }
        }

        function makeWf() {
            try {
                document.getElementById("watchface").innerHTML = '';
                document.getElementById("svg-cont").innerHTML = '';
                UIkit.notification.closeAll()
                var t = 0;
                var timeOnClock = [2, 0, 3, 8],
                    seconds = [4, 3],
                    am = 1,
                    analog = [45, 100, 260],
                    weekDay = 2,
                    day = 20,
                    month = 12,
                    battery = 2,
                    batteryT = 20,
                    calories = 2285,
                    steps = 28963,
                    stepsgoal = 12000,
                    distance = [5, 67],
                    pulse = 72,
                    temp = [22, 24];

                //Background
                if ('Background' in coords)
                    setPosN(coords.Background.Image);

                //Time
                if ('Time' in coords) {
                    setPosN(coords.Time.Hours.Tens, timeOnClock[0]);
                    setPosN(coords.Time.Hours.Ones, timeOnClock[1]);
                    setPosN(coords.Time.Minutes.Tens, timeOnClock[2]);
                    setPosN(coords.Time.Minutes.Ones, timeOnClock[3]);
                    if ('Seconds' in coords.Time) {
                        setPosN(coords.Time.Seconds.Tens, seconds[0]);
                        setPosN(coords.Time.Seconds.Ones, seconds[1]);
                    }
                    if ('AmPm' in coords.Time) {
                        t = am ? document.getElementById(coords.Time.AmPm.ImageIndexAm).cloneNode(false) : document.getElementById(coords.Time.AmPm.ImageIndexPm).cloneNode(false);
                        setPos(t, coords.Time.AmPm);
                        insert(t);
                    }
                }

                //Date
                if ('Date' in coords) {
                    //DayOfTheWeek
                    if ('WeekDay' in coords.Date) {
                        setPosN(coords.Date.WeekDay, weekDay);
                    }

                    //Date
                    if ('MonthAndDay' in coords.Date) {
                        if ('Separate' in coords.Date.MonthAndDay) {
                            if ('Day' in coords.Date.MonthAndDay.Separate) {
                                setTextPos(coords.Date.MonthAndDay.Separate.Day, day);
                            }
                            if ('Month' in coords.Date.MonthAndDay.Separate) {
                                setTextPos(coords.Date.MonthAndDay.Separate.Month, month);
                            }
                        }
                        if ('OneLine' in coords.Date.MonthAndDay) {
                            var dot = document.getElementById(coords.Date.MonthAndDay.OneLine.DelimiterImageIndex).cloneNode(false);
                            t = makeBlock(coords.Date.MonthAndDay.OneLine.Number, month);
                            t.block.push(dot);
                            t.width += dot.width + coords.Date.MonthAndDay.OneLine.Number.Spacing;
                            var t2 = makeBlock(coords.Date.MonthAndDay.OneLine.Number, day);
                            t.block = t.block.concat(t2.block);
                            t.width += t2.width;
                            renderBlock(t.block, t.width, coords.Date.MonthAndDay.OneLine.Number);
                        }
                    }
                }

                //Battery
                if ('Battery' in coords) {
                    if ('Icon' in coords.Battery) {
                        setPosN(coords.Battery.Icon, battery);
                    }
                    //Text
                    if ('Text' in coords.Battery) {
                        setTextPos(coords.Battery.Text, batteryT);
                    }
                    if ('Scale' in coords.Battery) {
                        var end = div(coords.Battery.Scale.Segments.length, 2);
                        for (var i = 0; i <= end; i++) {
                            t = document.getElementById(coords.Battery.Scale.StartImageIndex + i).cloneNode(false);
                            setPos(t, coords.Battery.Scale.Segments[i]);
                            insert(t);
                        }
                    }
                }

                if ('Status' in coords) {
                    //Alarm
                    if ('Alarm' in coords.Status) {
                        t = document.getElementById(coords.Status.Alarm.ImageIndexOn).cloneNode(false);
                        t.style.left = coords.Status.Alarm.Coordinates.X + "px";
                        t.style.top = coords.Status.Alarm.Coordinates.Y + "px";
                        insert(t);
                    }

                    //BT
                    if ('Bluetooth' in coords.Status) {
                        t = document.getElementById(coords.Status.Bluetooth.ImageIndexOn).cloneNode(false);
                        t.style.left = coords.Status.Bluetooth.Coordinates.X + "px";
                        t.style.top = coords.Status.Bluetooth.Coordinates.Y + "px";
                        insert(t);
                    }

                    //DoNotDistrurb
                    if ('DoNotDisturb' in coords.Status) {
                        t = document.getElementById(coords.Status.DoNotDisturb.ImageIndexOn).cloneNode(false);
                        t.style.left = coords.Status.DoNotDisturb.Coordinates.X + "px";
                        t.style.top = coords.Status.DoNotDisturb.Coordinates.Y + "px";
                        insert(t);
                    }

                    //Lock
                    if ('Lock' in coords.Status) {
                        t = document.getElementById(coords.Status.Lock.ImageIndexOn).cloneNode(false);
                        t.style.left = coords.Status.Lock.Coordinates.X + "px";
                        t.style.top = coords.Status.Lock.Coordinates.Y + "px";
                        insert(t);
                    }
                }

                //Activity
                if ('Activity' in coords) {
                    if ('Calories' in coords.Activity) {
                        setTextPos(coords.Activity.Calories, calories);
                    }
                    if ('Steps' in coords.Activity) {
                        setTextPos(coords.Activity.Steps, steps);
                    }
                    if ('StepsGoal' in coords.Activity) {
                        setTextPos(coords.Activity.StepsGoal, stepsgoal);
                    }
                    if ('Pulse' in coords.Activity) {
                        setTextPos(coords.Activity.Pulse, pulse);
                    }
                    if ('Distance' in coords.Activity) {
                        var dot = document.getElementById(coords.Activity.Distance.DecimalPointImageIndex).cloneNode(false),
                            km = document.getElementById(coords.Activity.Distance.SuffixImageIndex).cloneNode(false);
                        t = makeBlock(coords.Activity.Distance.Number, distance[0]);
                        t.block.push(dot);
                        t.width += dot.width + coords.Activity.Distance.Number.Spacing;
                        var t2 = makeBlock(coords.Activity.Distance.Number, distance[1]);
                        t.block = t.block.concat(t2.block);
                        t.width += t2.width;
                        t.block.push(km);
                        t.width += km.width;
                        renderBlock(t.block, t.width, coords.Activity.Distance.Number);
                    }
                }
                //WeatherText
                if ('Weather' in coords) {
                    if ('Icon' in coords.Weather) {
                        t = document.getElementById("weather").cloneNode(false);
                        t.style.left = coords.Weather.Icon.Coordinates.X + "px";
                        t.style.top = coords.Weather.Icon.Coordinates.Y + "px";
                        insert(t);
                    }
                    if ('Temperature' in coords.Weather) {
                        if ('Today' in coords.Weather.Temperature) {
                            if ('OneLine' in coords.Weather.Temperature.Today) {
                                var sep = document.getElementById(coords.Weather.Temperature.Today.OneLine.DelimiterImageIndex).cloneNode(false),
                                    deg = document.getElementById(coords.Weather.Temperature.Today.OneLine.DegreesImageIndex).cloneNode(false);
                                t = makeBlock(coords.Weather.Temperature.Today.OneLine.Number, temp[0]);
                                t.block.push(sep);
                                t.width += sep.width + coords.Weather.Temperature.Today.OneLine.Number.Spacing;
                                var t2 = makeBlock(coords.Weather.Temperature.Today.OneLine.Number, temp[1]);
                                t.block = t.block.concat(t2.block);
                                t.width += t2.width;
                                t.block.push(deg);
                                t.width += deg.width;
                                renderBlock(t.block, t.width, coords.Weather.Temperature.Today.OneLine.Number);
                            }
                            if ('Separate' in coords.Weather.Temperature.Today) {
                                t = makeBlock(coords.Weather.Temperature.Today.Separate.Day.Number, temp[0]);
                                if ('DegreesImageIndex' in coords.Weather.Temperature.Today.Separate.Day) {
                                    var deg = document.getElementById(coords.Weather.Temperature.Today.Separate.Day.DegreesImageIndex).cloneNode(false);
                                    t.block.push(deg);
                                    t.width += deg.width + coords.Weather.Temperature.Today.Separate.Day.Number.Spacing;
                                }
                                renderBlock(t.block, t.width, coords.Weather.Temperature.Today.Separate.Day.Number);
                                t = makeBlock(coords.Weather.Temperature.Today.Separate.Night.Number, temp[1]);
                                if ('DegreesImageIndex' in coords.Weather.Temperature.Today.Separate.Night) {
                                    var deg = document.getElementById(coords.Weather.Temperature.Today.Separate.Night.DegreesImageIndex).cloneNode(false);
                                    t.block.push(deg);
                                    t.width += deg.width + coords.Weather.Temperature.Today.Separate.Night.Number.Spacing;
                                }
                                renderBlock(t.block, t.width, coords.Weather.Temperature.Today.Separate.Night.Number);
                            }
                        }
                        if ('Current' in coords.Weather.Temperature) {
                            t = makeBlock(coords.Weather.Temperature.Current.Number, temp[0]);
                            if ('DegreesImageIndex' in coords.Weather.Temperature.Current) {
                                var deg = document.getElementById(coords.Weather.Temperature.Current.DegreesImageIndex).cloneNode(false);
                                t.block.push(deg);
                                t.width += deg.width + coords.Weather.Temperature.Current.Number.Spacing;
                            }
                            renderBlock(t.block, t.width, coords.Weather.Temperature.Current.Number);
                        }
                    }
                    if ('AirPollution' in coords.Weather)
                        setPosN(coords.Weather.AirPollution.Icon);
                }

                //StepsProgress
                if ('StepsProgress' in coords) {
                    if ('Circle' in coords.StepsProgress) {
                        var col = coords.StepsProgress.Circle.Color.replace("0x", "#");
                        document.getElementById('svg-cont').innerHTML += "<ellipse transform=\"rotate(" + (-90 + coords.StepsProgress.Circle.StartAngle) + " " + coords.StepsProgress.Circle.CenterX + " " + coords.StepsProgress.Circle.CenterY + ")\" cx=\"" + coords.StepsProgress.Circle.CenterX + "\" cy=\"" + coords.StepsProgress.Circle.CenterY + "\" rx=\"" + coords.StepsProgress.Circle.RadiusX + "\" ry=\"" + coords.StepsProgress.Circle.RadiusY + "\" fill=\"rgba(255,255,255,0)\" stroke-width=\"" + coords.StepsProgress.Circle.Width + "\" stroke=\"" + col + "\" stroke-dasharray=\"25% 75%\" stroke-linecap=\"round\"></ellipse>";
                    }
                    if ('Linear' in coords.StepsProgress) {
                        var end = div(coords.StepsProgress.Linear.Segments.length, 2);
                        for (var i = 0; i <= end; i++) {
                            t = document.getElementById(coords.StepsProgress.Linear.StartImageIndex + i).cloneNode(false);
                            setPos(t, coords.StepsProgress.Linear.Segments[i]);
                            insert(t);
                        }
                    }
                }

                //Analog clock
                if ('AnalogDialFace' in coords) {
                    if ('Hours' in coords.AnalogDialFace)
                        drowAnalog(coords.AnalogDialFace.Hours, analog[0]);
                    if ('Minutes' in coords.AnalogDialFace)
                        drowAnalog(coords.AnalogDialFace.Minutes, analog[1]);
                    if ('Seconds' in coords.AnalogDialFace)
                        drowAnalog(coords.AnalogDialFace.Seconds, analog[2]);
                }
            } catch (error) {
                console.error(error);
                if (error.name == "TypeError") {
                    UIkit.notification("Image for prorety not found", {
                        status: 'danger',
                        timeout: 7500
                    });
                }
            }
        }

    </script>
    <script type="text/javascript" src="html2canvas.comp.js"></script>
    <script type="text/javascript">
        function makepng() {
            var l = document.getElementById("canvasshot");
            if (l != null) l.parentElement.removeChild(l);
            html2canvas(document.body, {
                onrendered: function(canvas) {
                    canvas.setAttribute("id", "canvasshot");
                    document.getElementById("allimages").appendChild(canvas);
                },
                width: 176,
                height: 176
            });
            setTimeout(function() {
                var canvass = document.getElementById("canvasshot");
                console.log(canvass);
                ctx = canvass.getContext("2d");
                savedData = new Image();
                savedData.src = canvass.toDataURL("image/png");
                var a = document.createElement('a');
                a.href = savedData.src;
                a.download = 'watchface.png';
                a.click();
                delete a;
                delete savedData;
            }, 500);
        }

    </script>
</body>

</html>
